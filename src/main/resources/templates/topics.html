<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	<script src="static/vue/logout.js"></script>
	<script src="static/vue/left_topic.js"></script>
	<title>话题</title>
	<link href="static/css/navigation.css" rel="stylesheet" type="text/css">
	<link href="static/css/topics.css" rel="stylesheet" type="text/css">
</head>

<body>
<div class="header">
	<span style="margin-left: 10px;">whisperworld</span>
</div>
	<aside>
		<div class="nav" id="out">
			<span style="font-size: 20px;  letter-spacing: 2px;">功能列表</span>
			<a href="/home ">首页</a>
			<a href="/companion">好友</a>
			<a href="/group">群组</a>
			<a href="/topics"  class="active">话题</a>
			<a href="/profile">个人中心</a>
			<a href="/logout" @click.prevent="logout">退出登录</a>
		</div>
	</aside>
	<section>
		<div id="left">
			<div class="signature">个性签名</div>
			<div> 万事都要全力以赴，包括开心</div>
		</div>
		<div id="left1">
			<div>
				<p>留言板</p>
				<form  @submit.prevent="handleSubmit">
					<textarea v-model="topicContent" name="topicContent" rows="10" cols="20" placeholder="写点话题吧"></textarea><br>
					<button type="submit" class="send-button" >发送</button>
				</form>
			</div>
		</div>

		<div id="right" th:inline="none">
			<div v-for="topic in topics" :key="topic.topicId">
				<p>
					{{ topic.username }} -- {{ topic.topicContent }} -- {{ topic.topicLaunchTime }}
					<button @click="likeTopic(topic.topicId)">点赞</button>
				</p>

				<!-- 显示评论输入框 -->
				<textarea v-model="topic.commentContent" placeholder="留下你们的评论吧"></textarea>
				<button @click="submitComment(topic.topicId)">提交评论</button>

				<!-- 显示评论列表 -->

				<div v-for="comment in topic.comments" :key="comment.commentId">
					<p>
						{{ comment.topicCommentusername }} -- {{ comment.commentContent }} -- {{ comment.commentTime }}
					</p>
				</div>
			</div>

		</div>
	</section>
<div class="footer">欢迎使用社交网络系统</div>
<script>
	new Vue({
		el:'#right',
		data: {
			topics: [
				{
					topicId: 1,
					username: "User1",
					topicContent: "Topic 1",
					topicLaunchTime: "2023-11-12",
					comments: [
						{
							commentId: 1,
							topicCommentusername: "User2",
							commentContent: "Comment 1",
							commentTime: "2023-11-13",
						},
						// More comments for Topic 1
					],
				},
				// More topics
			],
		},

		mounted(){
			// 在组件挂载后，发送请求获取话题数据
			this.getTopics();
		},
		methods:{
			//获取话题
			getTopics(){
				// 使用 Axios 或其他方式发送请求获取话题数据
				axios.get('/api/getTopics')
						.then(response => {
							// 为每个话题对象指定唯一的 topicId
							this.topics = response.data;
							this.getComments();
						})
						.catch(error => {
							console.error('Error getting notices:', error);
						});
			},
			//点赞更新
			likeTopic(topicId) {
				// 检查用户是否已经点赞过该话题

					axios.post('/api/likeTopic', {"userId": this.userId,"topicId": topicId})
							.then((response) => {
								// 成功后更新点赞数量,(t)表示数组中的每个元素

								this.topics[this.topics.length- topicId].likeNum = response.data;
							})
							.catch((error) => {
								console.error('点赞时出错:', error);
							});
			},
			//评论
			getComments() {
				// 创建一个 promises 数组，每个元素是一个 Axios 请求
				const promises = this.topics.map(topic => {
					// 返回每个请求的 Promise
					return axios.get('/api/getComments/' + topic.topicId)
							.then(response => {
								// 获取到评论数据后更新话题的评论列表
//								topic.comments = response.data;
								this.$set(topic, 'comments', response.data);
							})
							.catch(error => {
								console.error('获取评论数据失败:', error);
							});
				});

				// 使用 Promise.all 等待所有请求完成
				Promise.all(promises)
						.then(() => {
							console.log('所有评论数据获取完成');
							// 所有请求完成后，可以执行其他逻辑
							this.topics.forEach((topic, i) => {
								console.log(`Topic ${i + 1}:`);
								console.log(`  Topic ID: ${topic.topicId}`);
								console.log(`  Username: ${topic.username}`);
								console.log(`  Topic Content: ${topic.topicContent}`);
								console.log(`  Launch Time: ${topic.topicLaunchTime}`);

								topic.comments.forEach((comment, j) => {
									console.log(`    Comment ${j + 1}:`);
									console.log(`      Comment ID: ${comment.commentId}`);
									console.log(`      Comment Username: ${comment.topicCommentusername}`);
									console.log(`      Comment Content: ${comment.commentContent}`);
									console.log(`      Comment Time: ${comment.commentTime}`);
								});
							});

						})
						.catch(error => {
							console.error('获取评论数据失败:', error);
						});
			},

			// 提交评论
			submitComment(topicId) {
				// 获取评论内容
				const commentContent = this.topics[this.topics.length- topicId].commentContent;
				// 做一些检查，确保评论内容不为空
				if (commentContent === '') {
					// 提示用户评论不能为空
					alert('评论不能为空！');
					return;
				}



				// 发送请求给后端，提交评论
				axios.post('/api/submitComment', {
					"topicId": topicId,
					"commentContent": commentContent
				})
						.then(response => {
							// 成功后更新界面或显示成功消息
							alert('评论提交成功！');

							// 清空评论输入框
							this.topics[this.topics.length-topicId].commentContent = '';

							// 刷新评论数据
							this.getComments();
						})
						.catch(error => {
							// 处理提交失败的情况，可能显示错误消息
							alert('评论提交失败，请重试！');
							console.error(error);
						});
			},
		},
	});
</script>
</body>
</html>